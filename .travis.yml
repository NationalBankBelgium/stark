language: node_js
node_js:
  - "10"
  - "12"

dist: trusty
sudo: false # better for performance

before_install:
  - echo $TRAVIS_COMMIT
  - echo $TRAVIS_TAG
  - echo $TRAVIS_BRANCH
  - echo $TRAVIS_BUILD_NUMBER
  - echo $TRAVIS_REPO
  - export TZ=Europe/Brussels
  - npm i -g npm@6.9.2
  - NODE_VERSION="$(node -v)"
  - echo $NODE_VERSION
  # Testing part is now handled by GitHub Actions. In a next PR, we'll the configuration to handle release process also in GitHub Actions.
  # See: https://github.com/NationalBankBelgium/stark/issues/2493
  - if [[ ${TRAVIS_TAG} == "" && ${TRAVIS_EVENT_TYPE} != "cron" ]]; then echo "Travis CI should be used ONLY for release process. Testing part should be done by GitHub Actions"; travis_terminate 0; fi  
  # This ensures that we are authenticated without requiring to have an actual .npmrc file within the project
  - 'echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> ~/.npmrc'

install:
  # Create file & folder for Travis logs
  # cfr scripts/_travis-fold.sh
  - mkdir -p $LOGS_DIR
  - touch $LOGS_DIR/build-perf.log
  - npm ci
  # FIXME Use ci scripts instead of travis-ci. Due to unexpected error with starter. See: https://github.com/NationalBankBelgium/stark/issues/2059
  - npm run install:travis-ci:all
  - npm run build:showcase:ghpages

env:
  global:
    - LOGS_DIR=/tmp/stark/logs
    - LOGS_FILE=/tmp/stark/logs/build-perf.log

branches:
  only:
    - master
    - /^\d+\.\d+\.\d(-alpha\.\d+|-beta\.\d+|-rc\.\d+)?$/

cache:
  directories:
    - $HOME/.npm

# Not needed since we use Puppeteer in karma.conf.ci.js
# It downloads Chrome itself and works with or without Travis
#  chrome: stable

script:
  # FIXME Use ci scripts instead of travis-ci. Due to unexpected error with starter. See: https://github.com/NationalBankBelgium/stark/issues/2059
  - npm run lint:travis-ci:all
  - npm run test:travis-ci:all
  # E2E tests only need to be run on 1 node version (v10)
  # and the secure environmentals BROWSERSTACK_USERNAME, BROWSERSTACK_ACCESS_KEY should be set. (only on secure builds)
  # E2E is now handled in GitHub Actions
  # - if [[ ${NODE_VERSION} =~ ^v10.*$ && -n "${BROWSERSTACK_USERNAME}" && -n "${BROWSERSTACK_ACCESS_KEY}"  ]]; then npm run test:showcase:e2e:browserstack; else echo "Skipping browserstack tests."; fi
  - npm run docs:travis-ci:coverage
  - npm run docs:publish
  - npm run release:publish
  - bash ./scripts/ci/print-logs.sh
